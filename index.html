<!DOCTYPE html>
<html>

<head>
    <title>Conceptual Er Designer</title>
    <meta charset="utf-8" />
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <style type="text/css">
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: "Roboto", sans-serif;
        }
        
        #scroller {
            width: 100%;
            height: 100%;
            background-color: #fff;
            background-image: url(img/grid.png);
            background-attachment: local;
            overflow-x: auto;
            overflow-y: auto;
        }
        
        #outerFixed {
            width: calc(100% - 300px);
            float: left;
            height: 100%;
            position: absolute;
        }
        
        #palette {
            width: 300px;
            height: 100%;
            float: right;
            background-color: #aaa;
            cursor: ew-resize;
        }
        
        #palette>div {
            height: 100%;
            margin-left: 2px;
            background: #fff;
            cursor: auto;
            box-sizing: border-box;
            padding: 5px;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        #palette h1 {
            display: block;
            font-size: 20px;
            margin: 0px 0px 10px 0px;
            color: #555;
        }
        
        #erXmlPre {
            height: 40%;
            width: 90ch;
            font-size: 10px;
            position: absolute;
            left: 0px;
            bottom: 0px;
            display: none;
        }
        
        #palette div+div {
            margin-top: 20px;
        }
        
        .dialogBackground {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0px;
            left: 0px;
            background-color: #000;
            opacity: 0.3;
        }
        
        #dialogContainer {
            display: none;
        }
        
        #dialogContainer.visible {
            display: block;
        }
        
        .dialog {
            position: absolute;
            width: 500px;
            height: 300px;
            background: #fff;
            margin-left: auto;
            margin-right: auto;
            margin-top: auto;
            margin-bottom: auto;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 1;
            padding: 10px;
            overflow-y: scroll;
        }
        
        .dialogContent {
            display: none
        }
        
        .dialogContent.visible {
            display: block
        }
        
        #closeDialog {
            position: absolute;
            right: 10px;
            top: 10px;
            width: 20px;
            cursor: pointer;
        }
        
        .dialog h1 {
            font-size: 24px;
        }
        
        button {
            min-width: 75px;
            background: #fff;
            border: 1px solid #aaa;
            padding: 5px;
            margin: 0px 10px 10px 0px;
        }
        
        button.on,
        button:active {
            background: #555;
            color: #fff;
        }
        
        svg {
            -webkit-touch-callout: none;
            /* iOS Safari */
            -webkit-user-select: none;
            /* Safari */
            -khtml-user-select: none;
            /* Konqueror HTML */
            -moz-user-select: none;
            /* Firefox */
            -ms-user-select: none;
            /* Internet Explorer/Edge */
            user-select: none;
            cursor: default;
            margin: 0;
            padding: 0
        }
        
        .panel {
            display: none;
        }
        
        .panel.visible {
            display: block;
        }
        
        .delete {
            display: block;
            height: 19px;
            width: 19px;
            float: right;
            background-image: url(img/delete.png);
            cursor: pointer;
        }
        
        .panel h1 {
            float: left;
        }
        
        .panel br {
            clear: both
        }
        
        .upAttr,
        .deleteAttr,
        .downAttr {
            width: 19px;
            height: 19px;
            display: inline-block;
            margin: 0px !important;
            padding: 0px;
        }
        
        td {
            white-space: nowrap;
            font-size: 0
        }
        
        .deleteAttr {
            background-image: url(img/delete.png);
        }
        
        .upAttr {
            background-image: url(img/up.png);
        }
        
        .downAttr {
            background-image: url(img/down.png);
        }
        
        .tip {
            font-size: 12px;
            /*position: absolute;
            bottom: 12px;*/
            margin-bottom: 12px;
            clear: both;
        }
        
        .innerPanel {
            padding: 3px;
        }
        
        #attrTable {
            margin-top: 10px;
        }
        
        input[type=text] {
            border: 1px solid #ccc;
            background: #eee;
            height: 24px;
        }
        
        input[type=text]:focus {
            background: #fff;
        }
        
        label {
            display: block;
            float: left;
            padding-top: 4px;
        }
        
        td {
            padding: 0px 0px 4px 0px;
        }
        
        #viewControls {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        
        #viewControls button {
            min-width: 40px;
        }
        
        .indent {
            padding-left: 10px;
        }
    </style>
</head>

<body>
    <div id="outerFixed">
        <div id="scroller">
            <svg xmlns="http://www.w3.org/2000/svg" id="drawing-area" height="100%" width="100%">
                <g id="svg-all" transform="scale(1)" />
            </svg>
        </div>
        <div id="viewControls">
            <button onclick="erp.zoomIn()">+</button>
            <button onclick="erp.zoomOut()">-</button>
        </div>
    </div>
    <div id="palette">
        <div>
            <div>
                <h1>ER Project</h1>
                <input type="file" id="upload" accept="text/xml" style="display:none" />
                <button onclick="newFile()">New</button>
                <button onclick="openFile()">Open</button>
                <button onclick="erp.saveFile()">Save</button><br/>
                <button onclick="erp.undo()">Undo</button>
                <button onclick="erp.redo()">Redo</button>
                <button onclick="erp.saveSVG()">Save SVG</button>
            </div>
            <div id="panelCreation" class="panel visible">
                <h1>Add...</h1><br/>
                <div class="tip">Choose "entity" or "relation", then click on the drawing area.</div>
                <button class="insertMode" onclick="erp.toggleInsertMode(this,newEntity)">Entity</button>
                <button class="insertMode" onclick="erp.toggleInsertMode(this,newRelation)">Relation</button>
                <h1>Participation</h1>
                <div class="tip">To add a participation, select both an entity and a relation (holding SHIFT), then choose "Add participation".

                </div>
            </div>
            <div id="panelEntity" class="panel">
                <div class="innerPanel">
                    <h1>Edit entity</h1>
                    <div class="delete" onclick="erp.deleteSelection()"></div><br/>
                    <div class="tip">Press ENTER after editing the name of the concept or the attributes; use the checkbox to set an attribute as primary.</div>
                    <label for="entityNameInput">Name:</label>
                    <input type="text" style="float:right" id="entityNameInput"></input>
                    <div style="margin-bottom: 12px;margin-bottom: 4px;clear:both">
                        Attributes
                    </div>
                    <table cellspacing="0" cellpadding="0" style="width:100%">
                        <tbody id="entityAttrTable" class="attrTable"></tbody>
                    </table>
                    <button id="entityAddAttr" onclick="entityAddAttribute()" style="width:100%;margin-right: 0;">Add attribute</button>
                </div>
            </div>
            <div id="panelRelation" class="panel">
                <div class="innerPanel">
                    <h1>Edit relation</h1>
                    <div class="delete" onclick="erp.deleteSelection()"></div><br/>
                    <div class="tip">Press ENTER after editing the name of the concept or the attributes; use the checkbox to set an attribute as primary.</div>
                    <label for="relationNameInput">Name:</label>
                    <input type="text" style="float:right" id="relationNameInput"></input>
                    <div style="margin-bottom: 12px;margin-bottom: 4px;clear:both">
                        Attributes
                    </div>
                    <table cellspacing="0" cellpadding="0" style="width:100%">
                        <tbody id="relationAttrTable" class="attrTable"></tbody>
                    </table>
                    <button id="relationAddAttr" onclick="relationAddAttribute()" style="width:100%;margin-right: 0;">Add attribute</button>
                </div>
            </div>
            <div id="panelParticipation" class="panel">
                <h1>Edit participation</h1>
                <div class="delete" onclick="erp.deleteSelection()"></div><br/> Multiplicity
                <br style="clear:both" />
                <label for="participationMultMin" class="indent">Min: </label>
                <input type="text" style="float:right" id="participationMultMin"></input>
                <br style="clear:both" />
                <label for="participationMultMax" class="indent">Max: </label>
                <input type="text" style="float:right" id="participationMultMax"></input>

            </div>
            <div id="panelMultipleSelection" class="panel">
                <h1>Edit selction</h1>
                <div class="delete" onclick="erp.deleteSelection()"></div><br/>
                <button id="addParticipation" onclick="erp.addParticipation()" disabled="true">Add participation</button>
            </div>
        </div>
    </div>
    <textarea autocomplete="off" id="erXmlPre" readonly="true"></textarea>
    </div>
    <script type="text/javascript" src="js/Attr.js"></script>
    <script type="text/javascript" src="js/Concept.js"></script>
    <script type="text/javascript" src="js/Entity.js"></script>
    <script type="text/javascript" src="js/ERProject.js"></script>
    <script type="text/javascript" src="js/Participation.js"></script>
    <script type="text/javascript" src="js/Relation.js"></script>
    <script type="text/javascript" src="js/util.js"></script>
    <script type="text/javascript" src="js/3rdparty/vkbeautify.js"></script>
    <script type="text/javascript" src="js/3rdparty/download.js"></script>
    <script type="text/javascript">
        var palette = document.getElementById("palette")
        var outerFixed = document.getElementById("outerFixed")
        var dragging = []
        var postDragging = null
        var erp
        palette.addEventListener("mousedown", function(ev) {
            var target = ev.target || ev.srcElement
            if (target == palette) {
                dragging.push(palette)
                palette.dragX = true
                palette.dragY = false
                palette.startX = ev.clientX
            }
        })
        palette.curWidth = 300
        palette.moveRelX = function(x) {
            var neww = this.curWidth - x
            if (neww > 290) {
                outerFixed.style.width = "calc(100% - " + neww + "px)"
                this.style.width = neww + "px"
            }
        }
        palette.endDragX = function(x) {
            this.curWidth = palette.clientWidth;
            erp.resizeSvg()
        }

        var svg = document.getElementById('drawing-area')

        var up = document.getElementById("upload")
        up.addEventListener("change", function() {
            erp = new ERProject(svg)
            var r = new FileReader()
            r.addEventListener("load", function(ev) {
                var parser = new DOMParser()
                try {
                    var doc = parser.parseFromString(ev.target.result, "text/xml")
                    erp.load(doc)
                } catch (e) {
                    alert("Could not read file: " + e)
                    console.log(e)
                }
            })
            r.readAsText(up.files[0])
        })

        function newFile() {
            erp = new ERProject(svg)
            var cb = new Callback(erp.load, erp, [])
            ajaxGet("empty.er.xml", cb, true)
        }

        function openFile() {
            up.click()
        }
        newFile()

        var dialogContainer = document.getElementById("dialogContainer")
    </script>
</body>

</html>